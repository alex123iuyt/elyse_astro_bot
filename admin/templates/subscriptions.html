{% extends "base.html" %}

{% block title %}–ü–æ–¥–ø–∏—Å–∫–∏ - Elyse Astro Admin{% endblock %}

{% block content %}
<div class="px-4 sm:px-6 lg:px-8">
    <div class="sm:flex sm:items-center">
        <div class="sm:flex-auto">
            <h1 class="text-2xl font-semibold text-zinc-100">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∞–º–∏</h1>
            <p class="mt-2 text-sm text-zinc-400">–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–º–∏—É–º-–ø–æ–¥–ø–∏—Å–∫–∞–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="mt-8 grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-4">
        <!-- Total Premium -->
        <div class="bg-zinc-900 overflow-hidden shadow rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-yellow-500 rounded-md flex items-center justify-center">
                            <span class="text-white text-lg">‚≠ê</span>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-zinc-400 truncate">–í—Å–µ–≥–æ –ø—Ä–µ–º–∏—É–º</dt>
                            <dd class="text-lg font-medium text-zinc-100">{{ stats.total_premium }}</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <!-- Active Premium -->
        <div class="bg-zinc-900 overflow-hidden shadow rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-green-500 rounded-md flex items-center justify-center">
                            <span class="text-white text-lg">‚úÖ</span>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-zinc-400 truncate">–ê–∫—Ç–∏–≤–Ω—ã—Ö</dt>
                            <dd class="text-lg font-medium text-zinc-100">{{ stats.active_premium }}</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <!-- Expired Premium -->
        <div class="bg-zinc-900 overflow-hidden shadow rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-red-500 rounded-md flex items-center justify-center">
                            <span class="text-white text-lg">‚è∞</span>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-zinc-400 truncate">–ò—Å—Ç–µ–∫—à–∏—Ö</dt>
                            <dd class="text-lg font-medium text-zinc-100">{{ stats.expired_premium }}</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <!-- Revenue -->
        <div class="bg-zinc-900 overflow-hidden shadow rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-emerald-500 rounded-md flex items-center justify-center">
                            <span class="text-white text-lg">üí∞</span>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-zinc-400 truncate">–î–æ—Ö–æ–¥ (–º–µ—Å)</dt>
                            <dd class="text-lg font-medium text-zinc-100">{{ stats.monthly_revenue }}</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="mt-8">
        <h2 class="text-lg font-medium text-zinc-100 mb-4">–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h2>
        <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3">
            <button 
                onclick="bulkExtendPremium()"
                class="bg-zinc-800 hover:bg-zinc-700 p-4 rounded-lg border border-zinc-700 hover:border-emerald-500 transition-colors text-left"
            >
                <div class="flex items-center">
                    <span class="text-2xl mr-3">‚è∞</span>
                    <div>
                        <h3 class="font-medium text-zinc-100">–ú–∞—Å—Å–æ–≤–æ–µ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ</h3>
                        <p class="text-sm text-zinc-400">–ü—Ä–æ–¥–ª–∏—Ç—å –ø—Ä–µ–º–∏—É–º –¥–ª—è –≥—Ä—É–ø–ø—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>
                    </div>
                </div>
            </button>

            <button 
                onclick="exportSubscriptions()"
                class="bg-zinc-800 hover:bg-zinc-700 p-4 rounded-lg border border-zinc-700 hover:border-emerald-500 transition-colors text-left"
            >
                <div class="flex items-center">
                    <span class="text-2xl mr-3">üìä</span>
                    <div>
                        <h3 class="font-medium text-zinc-100">–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</h3>
                        <p class="text-sm text-zinc-400">–í—ã–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ–¥–ø–∏—Å–æ–∫</p>
                    </div>
                </div>
            </button>

            <button 
                onclick="sendPremiumNotification()"
                class="bg-zinc-800 hover:bg-zinc-700 p-4 rounded-lg border border-zinc-700 hover:border-emerald-500 transition-colors text-left"
            >
                <div class="flex items-center">
                    <span class="text-2xl mr-3">üì¢</span>
                    <div>
                        <h3 class="font-medium text-zinc-100">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h3>
                        <p class="text-sm text-zinc-400">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–µ–º–∏—É–º-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º</p>
                    </div>
                </div>
            </button>
        </div>
    </div>

    <!-- Premium Users Table -->
    <div class="mt-8">
        <h2 class="text-lg font-medium text-zinc-100 mb-4">–ü—Ä–µ–º–∏—É–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h2>
        <div class="bg-zinc-900 shadow rounded-lg overflow-hidden">
            <div class="px-4 py-5 sm:p-6">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-zinc-800">
                        <thead>
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-zinc-400 uppercase tracking-wider">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-zinc-400 uppercase tracking-wider">–î–∞—Ç–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-zinc-400 uppercase tracking-wider">–ò—Å—Ç–µ–∫–∞–µ—Ç</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-zinc-400 uppercase tracking-wider">–û—Å—Ç–∞–ª–æ—Å—å –¥–Ω–µ–π</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-zinc-400 uppercase tracking-wider">–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody class="bg-zinc-800 divide-y divide-zinc-700">
                            {% for user in premium_users %}
                            <tr class="hover:bg-zinc-700">
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <div class="flex-shrink-0 h-8 w-8">
                                            <div class="h-8 w-8 rounded-full bg-emerald-600 flex items-center justify-center">
                                                <span class="text-white text-sm font-medium">{{ user.name[0] if user.name else '?' }}</span>
                                            </div>
                                        </div>
                                        <div class="ml-4">
                                            <div class="text-sm font-medium text-zinc-100">{{ user.name or '–ë–µ–∑ –∏–º–µ–Ω–∏' }}</div>
                                            <div class="text-sm text-zinc-400">ID: {{ user.tg_id }}</div>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-zinc-400">
                                    {{ user.created_at.strftime('%d.%m.%Y') if user.created_at else '‚Äî' }}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-zinc-400">
                                    {{ user.premium_until.strftime('%d.%m.%Y') if user.premium_until else '‚Äî' }}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    {% if user.premium_until %}
                                        {% set days_left = (user.premium_until - today).days %}
                                        {% if days_left > 0 %}
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                            {{ days_left }} –¥–Ω.
                                        </span>
                                        {% else %}
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                            –ò—Å—Ç–µ–∫
                                        </span>
                                        {% endif %}
                                    {% else %}
                                    <span class="text-zinc-400">‚Äî</span>
                                    {% endif %}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                    <div class="flex space-x-2">
                                        <button 
                                            onclick="extendPremium({{ user.tg_id }})"
                                            class="text-emerald-400 hover:text-emerald-300"
                                            title="–ü—Ä–æ–¥–ª–∏—Ç—å –ø—Ä–µ–º–∏—É–º"
                                        >
                                            ‚è∞
                                        </button>
                                        <button 
                                            onclick="revokePremium({{ user.tg_id }})"
                                            class="text-red-400 hover:text-red-300"
                                            title="–û—Ç–æ–∑–≤–∞—Ç—å –ø—Ä–µ–º–∏—É–º"
                                        >
                                            üö´
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
async function bulkExtendPremium() {
    const days = prompt('–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –¥–ª—è –º–∞—Å—Å–æ–≤–æ–≥–æ –ø—Ä–æ–¥–ª–µ–Ω–∏—è:', '30');
    if (days && !isNaN(days)) {
        if (confirm(`–ü—Ä–æ–¥–ª–∏—Ç—å –ø—Ä–µ–º–∏—É–º –Ω–∞ ${days} –¥–Ω–µ–π –¥–ª—è –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–µ–º–∏—É–º-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π?`)) {
            try {
                const response = await fetch('/api/subscriptions/bulk-extend', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ days: parseInt(days) })
                });
                if (response.ok) {
                    location.reload();
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –º–∞—Å—Å–æ–≤–æ–º –ø—Ä–æ–¥–ª–µ–Ω–∏–∏');
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å–∞');
            }
        }
    }
}

async function exportSubscriptions() {
    try {
        const response = await fetch('/api/subscriptions/export');
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'subscriptions_export.csv';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        } else {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ –¥–∞–Ω–Ω—ã—Ö');
        }
    } catch (error) {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å–∞');
    }
}

async function sendPremiumNotification() {
    const message = prompt('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–ª—è –ø—Ä–µ–º–∏—É–º-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:');
    if (message) {
        if (confirm('–û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤—Å–µ–º –∞–∫—Ç–∏–≤–Ω—ã–º –ø—Ä–µ–º–∏—É–º-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º?')) {
            try {
                const response = await fetch('/api/subscriptions/notify', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ message })
                });
                if (response.ok) {
                    alert('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã');
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π');
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å–∞');
            }
        }
    }
}

async function extendPremium(userId) {
    const days = prompt('–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –¥–ª—è –ø—Ä–æ–¥–ª–µ–Ω–∏—è –ø—Ä–µ–º–∏—É–º–∞:', '30');
    if (days && !isNaN(days)) {
        try {
            const response = await fetch(`/api/users/${userId}/extend-premium`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ days: parseInt(days) })
            });
            if (response.ok) {
                location.reload();
            } else {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–¥–ª–µ–Ω–∏–∏ –ø—Ä–µ–º–∏—É–º–∞');
            }
        } catch (error) {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å–∞');
        }
    }
}

async function revokePremium(userId) {
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–æ–∑–≤–∞—Ç—å –ø—Ä–µ–º–∏—É–º —É —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?')) {
        try {
            const response = await fetch(`/api/users/${userId}/premium`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ action: 'disable' })
            });
            if (response.ok) {
                location.reload();
            } else {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∑—ã–≤–µ –ø—Ä–µ–º–∏—É–º–∞');
            }
        } catch (error) {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å–∞');
        }
    }
}
</script>
{% endblock %}
