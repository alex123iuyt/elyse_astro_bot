# Исправление проблемы множественных запросов при выходе из профиля

## Проблема
После нажатия на кнопку "Выйти" в профиле происходило множество повторных запросов к API `/api/auth/me`, что приводило к:
- Множественным переадресациям между страницами
- Повторным компиляциям страниц
- Избыточной нагрузке на сервер
- Плохому пользовательскому опыту

## Причины проблемы
1. **Неполная очистка аутентификации**: При выходе очищался только `localStorage`, но не очищался cookie `elyse_token`
2. **Множественные проверки аутентификации**: Компонент `Guard` продолжал проверять аутентификацию через API, получая успешный ответ
3. **Отсутствие централизованного управления состоянием**: Каждая страница делала собственные запросы к API
4. **Отсутствие защиты от множественных кликов**: Кнопка выхода могла быть нажата несколько раз

## Решение

### 1. Создан API endpoint для выхода
- **Файл**: `webapp/app/api/auth/logout/route.ts`
- **Функция**: Очищает cookie `elyse_token` с правильными параметрами
- **Безопасность**: Использует `httpOnly`, `secure` и `sameSite` параметры

### 2. Создан контекст аутентификации
- **Файл**: `webapp/contexts/AuthContext.tsx`
- **Функции**: 
  - Централизованное управление состоянием аутентификации
  - Единая точка для проверки авторизации
  - Функция `logout()` для корректного выхода
- **Преимущества**: Избегает дублирующих запросов к API

### 3. Обновлен компонент Guard
- **Файл**: `webapp/app/(guard)/guard.tsx`
- **Изменения**: 
  - Использует контекст аутентификации вместо прямых API вызовов
  - Добавлено состояние loading для предотвращения мерцания
  - Убраны множественные проверки аутентификации

### 4. Обновлена страница профиля
- **Файл**: `webapp/app/profile/page.tsx`
- **Изменения**:
  - Использует контекст аутентификации для выхода
  - Добавлена защита от множественных кликов на кнопку выхода
  - Показывает состояние загрузки при выходе
  - Использует `router.replace()` вместо `router.push()`

### 5. Обновлены другие страницы
- **Главная страница** (`webapp/app/page.tsx`): Убраны дублирующие проверки аутентификации
- **Страница админа** (`webapp/app/admin/page.tsx`): Использует контекст аутентификации
- **Страница приветствия** (`webapp/app/welcome/page.tsx`): Убраны лишние API вызовы
- **Страница аутентификации** (`webapp/app/auth/page.tsx`): Добавлена проверка уже авторизованных пользователей

### 6. Обновлен корневой layout
- **Файл**: `webapp/app/layout.tsx`
- **Изменения**: Добавлен `AuthProvider` для обертывания всего приложения

## Результат
✅ **Устранены множественные запросы** при выходе из профиля  
✅ **Улучшена производительность** - убраны дублирующие API вызовы  
✅ **Улучшен UX** - добавлены состояния загрузки и защита от множественных кликов  
✅ **Централизовано управление** состоянием аутентификации  
✅ **Повышена безопасность** - корректная очистка cookie при выходе  

## Технические детали

### Cookie очистка
```typescript
response.cookies.set('elyse_token', '', {
  httpOnly: true,
  secure: process.env.NODE_ENV === 'production',
  sameSite: 'lax',
  maxAge: 0, // Немедленное истечение
  path: '/'
});
```

### Защита от множественных кликов
```typescript
const [isLoggingOut, setIsLoggingOut] = useState(false);

const handleLogout = async () => {
  if (isLoggingOut) return; // Защита от множественных кликов
  setIsLoggingOut(true);
  // ... логика выхода
};
```

### Использование контекста
```typescript
const { user, isAuthenticated, isLoading, logout } = useAuth();

// Вместо прямых API вызовов
await logout();
```

## Тестирование
После внесения изменений:
1. Войдите в профиль
2. Нажмите кнопку "Выйти"
3. Проверьте, что происходит только один запрос к `/api/auth/logout`
4. Убедитесь, что происходит корректная переадресация на `/welcome`
5. Проверьте, что cookie `elyse_token` очищен
6. Убедитесь, что нет множественных запросов к `/api/auth/me`






