# Исправление проблемы входа в Elyse Astro

## Проблема
После входа в систему пользователь не может получить доступ к приложению. Показывается сообщение "Вход выполнен", но перенаправление не происходит.

**Дополнительная проблема**: Бесконечные циклы перенаправлений и спам запросами к API.

## Причины проблемы
1. **Отсутствует пользователь admin в базе данных** - в SQLite базе нет пользователя с ролью admin
2. **Неправильная проверка аутентификации в middleware** - middleware проверял неправильные cookie
3. **Неправильная логика перенаправления** - после входа пользователь не перенаправлялся в нужное место
4. **Бесконечные циклы** между главной страницей и админкой
5. **Множественные вызовы API** из-за неправильных useEffect

## Решение

### 1. Создание администратора в базе данных

Перейдите в папку `scripts` и установите зависимости:

```bash
cd webapp/scripts
npm install
```

Запустите скрипт создания администратора:

```bash
npm run create-admin
```

Это создаст пользователя:
- **Email**: admin@elyse.local
- **Пароль**: admin123
- **Роль**: admin

### 2. Исправления в коде

#### Middleware (webapp/middleware.ts)
- Исправлена проверка аутентификации через `elyse_token` cookie вместо `next-auth.session-token`
- Добавлены комментарии для предотвращения циклов

#### Страница входа (webapp/app/auth/page.tsx)
- Добавлена поддержка callback URL для правильного перенаправления
- Исправлена логика перенаправления после входа в зависимости от роли пользователя

#### Главная страница (webapp/app/page.tsx)
- Добавлена специальная страница для админов
- Исправлена логика перенаправления для предотвращения циклов
- Админы могут оставаться на главной странице

#### Админ панель (webapp/app/admin/page.tsx)
- Исправлены useEffect для предотвращения множественных вызовов API
- Добавлена функция выхода из системы
- Статистика загружается только при необходимости

#### Страница welcome (webapp/app/welcome/page.tsx)
- Создана простая страница для неавторизованных пользователей
- Правильная логика перенаправления

### 3. Проверка исправления

1. **Запустите приложение**:
   ```bash
   cd webapp
   npm run dev
   ```

2. **Откройте страницу входа**: http://localhost:3000/auth

3. **Войдите с учетными данными администратора**:
   - Email: admin@elyse.local
   - Пароль: admin123

4. **Проверьте перенаправление**: после входа вы должны быть перенаправлены на `/admin`

5. **Проверьте главную страницу**: перейдите на `/` - должна показаться специальная страница для админа

6. **Проверьте выход**: используйте кнопку "Выйти" в админ панели

### 4. Тестирование

- Попробуйте зайти на защищенные страницы админки: `/admin/content`, `/admin/users`
- Проверьте, что middleware правильно перенаправляет неавторизованных пользователей на страницу входа
- Убедитесь, что после входа пользователь попадает в нужное место
- Проверьте, что нет бесконечных циклов и спама запросами

### 5. Структура исправлений

```
webapp/
├── middleware.ts (исправлена проверка аутентификации)
├── app/
│   ├── auth/page.tsx (исправлена логика перенаправления)
│   ├── page.tsx (добавлена страница для админов)
│   ├── admin/page.tsx (исправлены useEffect)
│   └── welcome/page.tsx (создана страница welcome)
├── scripts/
│   ├── create-admin-sqlite.js (создание админа)
│   └── package.json (зависимости для скриптов)
└── LOGIN_FIX_README.md (этот файл)
```

## Дополнительные замечания

- Убедитесь, что база данных `webapp/data/elyse.db` существует и доступна для записи
- Проверьте, что все необходимые зависимости установлены в основном проекте
- Если проблема сохраняется, проверьте консоль браузера и сервера на наличие ошибок
- Админы теперь могут свободно перемещаться между главной страницей и админ панелью
- Добавлена кнопка выхода из системы в админ панели

## Контакты

Если у вас возникли вопросы или проблемы, обратитесь к разработчикам Elyse Astro.
