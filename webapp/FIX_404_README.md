# Исправление ошибки 404 при доступе к админке

## Проблема
При попытке доступа к `/admin` middleware перенаправляет на `/api/auth/signin`, который не существует, что приводит к ошибке 404.

## Решение

### 1. Установка зависимостей
```bash
cd webapp
pnpm install
```

### 2. Обновление базы данных
```bash
# Применяем новые схемы
pnpm run db:push

# Генерируем Prisma клиент
pnpm run db:generate
```

### 3. Создание тестового пользователя с ролью ADMIN
```bash
# Создаем админ-пользователя
pnpm run create-admin
```

Это создаст пользователя:
- **Email:** admin@elyse.com
- **Пароль:** admin123
- **Роль:** ADMIN

### 4. Миграция контента
```bash
# Запускаем миграцию существующего контента
pnpm run migrate-content
```

### 5. Проверка исправления

1. **Запустите приложение:**
   ```bash
   pnpm run dev
   ```

2. **Войдите в систему:**
   - Откройте http://localhost:3000/auth
   - Введите email: `admin@elyse.com`
   - Введите пароль: `admin123`

3. **Доступ к админке:**
   - После успешного входа перейдите на http://localhost:3000/admin/content
   - Должна открыться страница управления контентом

## Что было исправлено

### ✅ Middleware
- Теперь перенаправляет на `/auth` вместо несуществующего `/api/auth/signin`

### ✅ Схема базы данных
- Добавлены недостающие поля в модель User для астрологических данных
- Поддержка новых типов контента

### ✅ Скрипты
- `create-admin` - создание тестового пользователя
- `migrate-content` - миграция существующего контента
- `generate-today` - генерация ежедневного контента

### ✅ API роуты
- Публичные API для чтения контента
- Защищенные API для управления контентом

## Структура исправлений

```
webapp/
├── middleware.ts              # ✅ Исправлен редирект
├── packages/db/schema.prisma  # ✅ Добавлены поля User
├── scripts/
│   ├── create-admin-user.ts   # ✅ Создание админ-пользователя
│   ├── migrate-content.ts     # ✅ Миграция контента
│   └── generate-today.ts      # ✅ Генерация контента
├── app/
│   ├── api/
│   │   ├── content/           # ✅ Публичные API
│   │   └── admin/             # ✅ Защищенные API
│   ├── admin/                 # ✅ Админские страницы
│   └── auth/                  # ✅ Страница авторизации
└── contexts/
    └── AuthContext.tsx        # ✅ Контекст авторизации
```

## Проверка работоспособности

### 1. Публичные API (без авторизации)
```bash
# Советы дня
curl "http://localhost:3000/api/content/daily-tips"

# Прогнозы
curl "http://localhost:3000/api/content/daily-forecast"

# Лунный календарь
curl "http://localhost:3000/api/content/lunar-today"

# Сторис
curl "http://localhost:3000/api/content/stories"
```

### 2. Защищенные API (требуют авторизации)
```bash
# Генерация контента (только для ADMIN/EDITOR)
curl -X POST "http://localhost:3000/api/admin/generate/today" \
  -H "Content-Type: application/json" \
  -d '{"date":"2025-01-27","tz":"Europe/Amsterdam"}'
```

### 3. Фронтенд
- Страница "Сегодня" загружает контент из CMS
- Админка доступна после авторизации
- Навигация работает корректно

## Troubleshooting

### Ошибка "Database tables initialized successfully"
Это нормально - база данных инициализируется при первом запуске.

### Ошибка "Login error: Неверный email или пароль"
Убедитесь, что:
1. Запустили `pnpm run create-admin`
2. Используете правильные данные: `admin@elyse.com` / `admin123`

### Ошибка "PrismaClient not found"
```bash
pnpm run db:generate
```

### Ошибка "Role is not defined"
```bash
pnpm run db:push
```

## Следующие шаги

После исправления ошибки 404:

1. **Создайте контент** через админку
2. **Проверьте отображение** на странице "Сегодня"
3. **Используйте генерацию** для создания черновиков
4. **Настройте планировщик** для автоматической публикации

## Поддержка

Если проблемы остаются:
1. Проверьте логи сервера
2. Убедитесь, что все скрипты выполнены
3. Проверьте переменные окружения
4. Перезапустите сервер разработки




